import*as u from"fs";import k from"adm-zip";import j from"path";var l={ensureDirectory(e){this.pathExists(e)||u.mkdirSync(e,{recursive:!0})},pathExists(e){return u.existsSync(e)},readFile(e,t){return u.readFileSync(e,{encoding:t??"utf8"})},fileHasExtension(e,t){return(Array.isArray(t)?t:[t]).includes(j.extname(e).slice(1).toLowerCase())},zipCompress(e,t){let r=new k;for(let o of t)typeof o=="string"?r.addLocalFile(o):r.addFile(o.filename,Buffer.from(o.content,"utf8"));return r.writeZip(e),e}};function p(e){let t=P(),r=$(t,e);return t.extra.thunderbird={name:r.name??t.displayName??t.name,version:r.version??t.version,themeId:r.themeId??`${t.name}@addons.thunderbird.net`,thunderbirdMinVersion:r.thunderbirdMinVersion??"115",thunderbirdMaxVersion:r.thunderbirdMaxVersion??"128",stylesPath:r.stylesPath,author:{name:r.author?.name??t.author?.name,url:r.author?.url??t.author?.url},srcDir:r.srcDir??"src",outDir:r.outDir??"build",assetsDir:r.assetsDir},t}function P(){let e=JSON.parse(l.readFile("package.json"));return e.extra||(e.extra={thunderbird:{}}),e}function $(e,t){return{...e.extra?.thunderbird??{},...t??{}}}import s from"joi";var g={generate(e,t,r,o){let n=r.extra.thunderbird;return{manifest_version:2,name:n.name,version:n.version,description:r.description,author:n.author.name,homepage_url:n.author.url,browser_specific_settings:{gecko:{id:n.themeId,strict_min_version:n.thunderbirdMinVersion,strict_max_version:n.thunderbirdMaxVersion}},theme:{colors:e.colors,images:t},theme_experiment:{stylesheet:o?`${r.name}.css`:void 0,colors:e.experimentColors}}},validate(e){let t=s.object({name:s.string().required(),version:s.string().pattern(/^(0|[1-9][0-9]{0,8})([.](0|[1-9][0-9]{0,8})){0,3}$/u).required(),displayName:s.string(),description:s.string(),author:s.object({name:s.string(),url:s.string()}),extra:s.object({thunderbird:s.object({name:s.string().required(),version:s.string().pattern(/^\d+([.]\d+){0,2}$/u),themeId:s.alternatives().try(s.string().email({tlds:{allow:!1}}),s.string().pattern(/^\{[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\}$/iu)),thunderbirdMinVersion:s.string().pattern(/^\d+(\.\d+)?$/u).required(),thunderbirdMaxVersion:s.string().pattern(/^\d+(\.\d+)?$/u).required(),stylesPath:s.alternatives().try(s.string(),s.array().items(s.string())),author:s.object({name:s.string(),url:s.string()}).required(),srcDir:s.string().required(),outDir:s.string().required(),assetsDir:s.string()})})}).unknown();s.assert(e,t);let r=e.extra.thunderbird;if(r.assetsDir&&!l.pathExists(r.assetsDir))throw new Error(`Invalid assets directory '${r.assetsDir}'`)}};import v from"path";import{readdirSync as G}from"fs";import*as b from"sass";import{lstatSync as w,readdirSync as D}from"fs";import x from"path";var f={getStylePaths(e){let t=e.stylesPath;if(!t)return;let r=(Array.isArray(t)?t:[t]).map(o=>x.join(e.srcDir,o));return r.forEach(o=>{if(o&&!l.pathExists(o))throw new Error(`Styles path "${o}" not found.`)}),r},processStylePaths(e){return e.map(t=>w(t).isDirectory()?S(t):y(t)).join(`
`)}};function S(e){let t=["css","scss","sass"];return D(e).filter(r=>l.fileHasExtension(r,t)).sort().map(r=>y(x.join(e,r))).join(`
`)}function y(e){return b.compile(e,{style:"expanded"}).css}import a from"joi";var T={color_scheme:{themecol_light_01:"#336699"},theme_colors:{button_background_active:"",button_background_hover:"",frame:"",frame_inactive:"",icons:"",icons_attention:"",popup:"",popup_border:"",popup_highlight:"",popup_highlight_text:"",popup_text:"",sidebar:"",sidebar_border:"",sidebar_highlight:"",sidebar_highlight_border:"",sidebar_highlight_text:"",sidebar_text:"",tab_background_separator:"",tab_background_text:"",tab_line:"",tab_loading:"",tab_selected:"",tab_text:"",toolbar:"",toolbar_bottom_separator:"",toolbar_field:"",toolbar_field_border:"",toolbar_field_border_focus:"",toolbar_field_focus:"",toolbar_field_highlight:"",toolbar_field_highlight_text:"",toolbar_field_text:"",toolbar_field_text_focus:"",toolbar_text:"",toolbar_top_separator:"",toolbar_vertical_separator:""},theme_experiment_colors:{}};var _={parseColors(e){let t=E(e.color_scheme,e.theme_colors??{}),{colors:r,experimentColors:o}=M(e.color_scheme,e.theme_experiment_colors??{}),{colors:n,experimentColors:i}=O(e.color_scheme);return{colors:{...t,...r,...n},experimentColors:{...o,...i}}},validate(e){let t=a.object({color_scheme:a.object().pattern(a.string(),a.alternatives().try(a.number(),a.string())).required(),theme_colors:a.object().pattern(a.string(),a.string()),theme_experiment_colors:a.object().pattern(a.string(),a.string()),images:a.object().pattern(a.string(),a.string())});a.assert(e,t),F(e);let r=[...Object.values(e.theme_colors??{}),...Object.values(e.theme_experiment_colors??{})].filter((i,c,d)=>i===d[c]),o=r.filter(i=>!(i in e.color_scheme));if(o.length>0)throw new Error(`Missing color definitions:
${m(o)}`);let n=Object.keys(e.color_scheme).filter(i=>!r.includes(i));n.length>0&&console.warn(`* Colors not referenced in 'theme_colors' nor 'theme_experiment_colors':
${m(n)}`)}};function E(e,t){return Object.entries(t).reduce((r,[o,n])=>(r[o]=e[n],r),{})}function M(e,t){return Object.entries(t).reduce((r,[o,n])=>{let i=n+o.replaceAll("-","_"),c=e[n];return r.colors[i]=c,r.experimentColors[i]=o,r},{colors:{},experimentColors:{}})}function O(e){return Object.entries(e).reduce((t,[r,o])=>{t.colors[r]=o;let n=`--${r}`;return t.experimentColors[r]=n,t},{colors:{},experimentColors:{}})}function F(e){q(e),V(e)}function V(e){if(!e.theme_colors)return;let t=A(),r=Object.keys(e.theme_colors),o=r.filter(i=>!t.includes(i));if(o.length)throw new Error(`Invalid color keys:
${m(o)}
Valid colors are:
${m(t)}`);let n=t.filter(i=>!r.includes(i));n.length&&console.warn(`* Theme colors missing in 'theme_colors':
${m(n)}`)}function q(e){let t=Object.values(e.color_scheme).map(o=>o.replaceAll(" ","")),r=I(t);if(r.length)throw new Error(`Duplicated color keys:
${m(r)}`)}function I(e){return[...new Set(e.filter((t,r,o)=>o.indexOf(t)!==r))]}function A(){let e=T.theme_colors;return Object.keys(e)}function m(e){return JSON.stringify(e,null,1)}function ue(e,t){let r=p(t),o=r.extra.thunderbird;l.ensureDirectory(o.outDir);try{g.validate(r),_.validate(e)}catch(C){console.error(C),console.log();return}let n=f.getStylePaths(o),i=n?f.processStylePaths(n):void 0,c=_.parseColors(e),d=g.generate(c,e.images,r,!!i),h=J(d,r,i);R(d,h)}function J(e,t,r){let o=[{filename:"manifest.json",content:JSON.stringify(e,null,1)}];if(e.theme_experiment.stylesheet&&r&&o.push({filename:e.theme_experiment.stylesheet,content:r}),t.extra.thunderbird.assetsDir){let c=[".DS_Store"],{assetsDir:d}=t.extra.thunderbird;G(d).forEach(h=>{c.includes(h)||o.push(v.join(d,h))})}let n=`${t.name.replaceAll(".","-")}.xpi`,i=v.join(t.extra.thunderbird.outDir,n);return l.zipCompress(i,o),i}function R(e,t){let r=[`Theme: ${e.name}`,`Id: ${e.browser_specific_settings.gecko.id}`,`Version: ${e.version}`,`File: ${t}`],o=r.reduce((n,i)=>i.length>n?i.length:n,0);console.log(`
 .${"-".repeat(o)}. `);for(let n of r){let i=" ".repeat(o-n.length);console.log(`| ${n}${i} |`)}console.log(` '${"-".repeat(o)}' `)}export{ue as build};

import*as u from"fs";import k from"adm-zip";import j from"path";var l={ensureDirectory(e){this.pathExists(e)||u.mkdirSync(e,{recursive:!0})},pathExists(e){return u.existsSync(e)},readFile(e,r){return u.readFileSync(e,{encoding:r??"utf8"})},fileHasExtension(e,r){return(Array.isArray(r)?r:[r]).includes(j.extname(e).slice(1).toLowerCase())},zipCompress(e,r){let t=new k;for(let o of r)typeof o=="string"?t.addLocalFile(o):t.addFile(o.filename,Buffer.from(o.content,"utf8"));return t.writeZip(e),e}};function p(e){let r=P(),t=$(r,e);return r.extra.thunderbird={name:t.name??r.displayName??r.name,version:t.version??r.version,themeId:t.themeId??`${r.name}@addons.thunderbird.net`,thunderbirdMinVersion:t.thunderbirdMinVersion??"115.0",thunderbirdMaxVersion:t.thunderbirdMaxVersion??"128.6",stylesPath:t.stylesPath,author:{name:t.author?.name??r.author?.name,url:t.author?.url??r.author?.url},homepage:r.homepage,srcDir:t.srcDir??"src",outDir:t.outDir??"build",assetsDir:t.assetsDir},r}function P(){let e=JSON.parse(l.readFile("package.json"));return e.extra||(e.extra={thunderbird:{}}),e}function $(e,r){return{...e.extra?.thunderbird??{},...r??{}}}import s from"joi";var g={generate(e,r,t,o){let n=t.extra.thunderbird;return{manifest_version:2,name:n.name,version:n.version,description:t.description,author:n.author.name,homepage_url:n.homepage??n.author.url,browser_specific_settings:{gecko:{id:n.themeId,strict_min_version:n.thunderbirdMinVersion,strict_max_version:n.thunderbirdMaxVersion}},theme:{colors:e.colors,images:r},theme_experiment:{stylesheet:o?`${t.name}.css`:void 0,colors:e.experimentColors}}},validate(e){let r=s.object({name:s.string().required(),version:s.string().pattern(/^(0|[1-9][0-9]{0,8})([.](0|[1-9][0-9]{0,8})){0,3}$/u).required(),displayName:s.string(),description:s.string(),author:s.object({name:s.string(),url:s.string()}),extra:s.object({thunderbird:s.object({name:s.string().required(),version:s.string().pattern(/^\d+([.]\d+){0,2}$/u),themeId:s.alternatives().try(s.string().email({tlds:{allow:!1}}),s.string().pattern(/^\{[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\}$/iu)),thunderbirdMinVersion:s.string().pattern(/^\d+(\.\d+)?$/u).required(),thunderbirdMaxVersion:s.string().pattern(/^\d+(\.\d+)?$/u).required(),stylesPath:s.alternatives().try(s.string(),s.array().items(s.string())),author:s.object({name:s.string(),url:s.string()}).required(),homepage:s.string(),srcDir:s.string().required(),outDir:s.string().required(),assetsDir:s.string()})})}).unknown();s.assert(e,r);let t=e.extra.thunderbird;if(t.assetsDir&&!l.pathExists(t.assetsDir))throw new Error(`Invalid assets directory '${t.assetsDir}'`)}};import v from"path";import{readdirSync as G}from"fs";import*as b from"sass";import{lstatSync as w,readdirSync as D}from"fs";import x from"path";var f={getStylePaths(e){let r=e.stylesPath;if(!r)return;let t=(Array.isArray(r)?r:[r]).map(o=>x.join(e.srcDir,o));return t.forEach(o=>{if(o&&!l.pathExists(o))throw new Error(`Styles path "${o}" not found.`)}),t},processStylePaths(e){return e.map(r=>w(r).isDirectory()?S(r):y(r)).join(`
`)}};function S(e){let r=["css","scss","sass"];return D(e).filter(t=>l.fileHasExtension(t,r)).sort().map(t=>y(x.join(e,t))).join(`
`)}function y(e){return b.compile(e,{style:"expanded"}).css}import a from"joi";var T={color_scheme:{themecol_light_01:"#336699"},theme_colors:{button_background_active:"",button_background_hover:"",frame:"",frame_inactive:"",icons:"",icons_attention:"",popup:"",popup_border:"",popup_highlight:"",popup_highlight_text:"",popup_text:"",sidebar:"",sidebar_border:"",sidebar_highlight:"",sidebar_highlight_border:"",sidebar_highlight_text:"",sidebar_text:"",tab_background_separator:"",tab_background_text:"",tab_line:"",tab_loading:"",tab_selected:"",tab_text:"",toolbar:"",toolbar_bottom_separator:"",toolbar_field:"",toolbar_field_border:"",toolbar_field_border_focus:"",toolbar_field_focus:"",toolbar_field_highlight:"",toolbar_field_highlight_text:"",toolbar_field_text:"",toolbar_field_text_focus:"",toolbar_text:"",toolbar_top_separator:"",toolbar_vertical_separator:""},theme_experiment_colors:{}};var _={parseColors(e){let r=E(e.color_scheme,e.theme_colors??{}),{colors:t,experimentColors:o}=M(e.color_scheme,e.theme_experiment_colors??{}),{colors:n,experimentColors:i}=O(e.color_scheme);return{colors:{...r,...t,...n},experimentColors:{...o,...i}}},validate(e){let r=a.object({color_scheme:a.object().pattern(a.string(),a.alternatives().try(a.number(),a.string())).required(),theme_colors:a.object().pattern(a.string(),a.string()),theme_experiment_colors:a.object().pattern(a.string(),a.string()),images:a.object().pattern(a.string(),a.string())});a.assert(e,r),F(e);let t=[...Object.values(e.theme_colors??{}),...Object.values(e.theme_experiment_colors??{})].filter((i,c,d)=>i===d[c]),o=t.filter(i=>!(i in e.color_scheme));if(o.length>0)throw new Error(`Missing color definitions:
${m(o)}`);let n=Object.keys(e.color_scheme).filter(i=>!t.includes(i));n.length>0&&console.warn(`* Colors not referenced in 'theme_colors' nor 'theme_experiment_colors':
${m(n)}`)}};function E(e,r){return Object.entries(r).reduce((t,[o,n])=>(t[o]=e[n],t),{})}function M(e,r){return Object.entries(r).reduce((t,[o,n])=>{let i=n+o.replaceAll("-","_"),c=e[n];return t.colors[i]=c,t.experimentColors[i]=o,t},{colors:{},experimentColors:{}})}function O(e){return Object.entries(e).reduce((r,[t,o])=>{r.colors[t]=o;let n=`--${t}`;return r.experimentColors[t]=n,r},{colors:{},experimentColors:{}})}function F(e){q(e),V(e)}function V(e){if(!e.theme_colors)return;let r=A(),t=Object.keys(e.theme_colors),o=t.filter(i=>!r.includes(i));if(o.length)throw new Error(`Invalid color keys:
${m(o)}
Valid colors are:
${m(r)}`);let n=r.filter(i=>!t.includes(i));n.length&&console.warn(`* Theme colors missing in 'theme_colors':
${m(n)}`)}function q(e){let r=Object.values(e.color_scheme).map(o=>o.replaceAll(" ","")),t=I(r);if(t.length)throw new Error(`Duplicated color keys:
${m(t)}`)}function I(e){return[...new Set(e.filter((r,t,o)=>o.indexOf(r)!==t))]}function A(){let e=T.theme_colors;return Object.keys(e)}function m(e){return JSON.stringify(e,null,1)}function ue(e,r){let t=p(r),o=t.extra.thunderbird;l.ensureDirectory(o.outDir);try{g.validate(t),_.validate(e)}catch(C){console.error(C),console.log();return}let n=f.getStylePaths(o),i=n?f.processStylePaths(n):void 0,c=_.parseColors(e),d=g.generate(c,e.images,t,!!i),h=J(d,t,i);R(d,h)}function J(e,r,t){let o=[{filename:"manifest.json",content:JSON.stringify(e,null,1)}];if(e.theme_experiment.stylesheet&&t&&o.push({filename:e.theme_experiment.stylesheet,content:t}),r.extra.thunderbird.assetsDir){let c=[".DS_Store"],{assetsDir:d}=r.extra.thunderbird;G(d).forEach(h=>{c.includes(h)||o.push(v.join(d,h))})}let n=`${r.name.replaceAll(".","-")}.xpi`,i=v.join(r.extra.thunderbird.outDir,n);return l.zipCompress(i,o),i}function R(e,r){let t=[`Theme: ${e.name}`,`Id: ${e.browser_specific_settings.gecko.id}`,`Version: ${e.version}`,`File: ${r}`],o=t.reduce((n,i)=>i.length>n?i.length:n,0);console.log(`
 .${"-".repeat(o)}. `);for(let n of t){let i=" ".repeat(o-n.length);console.log(`| ${n}${i} |`)}console.log(` '${"-".repeat(o)}' `)}export{ue as build};

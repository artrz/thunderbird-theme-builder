import*as u from"fs";import j from"adm-zip";import k from"path";var l={ensureDirectory(e){this.pathExists(e)||u.mkdirSync(e,{recursive:!0})},pathExists(e){return u.existsSync(e)},readFile(e,t){return u.readFileSync(e,{encoding:t??"utf8"})},fileHasExtension(e,t){return(Array.isArray(t)?t:[t]).includes(k.extname(e).slice(1).toLowerCase())},zipCompress(e,t){let r=new j;for(let o of t)typeof o=="string"?r.addLocalFile(o):r.addFile(o.filename,Buffer.from(o.content,"utf8"));return r.writeZip(e),e}};function h(e){let t=$(),r=w(t,e);return t.extra.thunderbird={name:r.name??t.displayName??t.name,version:r.version??t.version,themeId:r.themeId??`${t.name}@addons.thunderbird.net`,thunderbirdMinVersion:r.thunderbirdMinVersion??"115.0",stylesPath:r.stylesPath,author:{name:r.author?.name??t.author?.name,url:r.author?.url??t.author?.url},srcDir:r.srcDir??"src",outDir:r.outDir??"build",assetsDir:r.assetsDir},t}function $(){let e=JSON.parse(l.readFile("package.json"));return e.extra||(e.extra={thunderbird:{}}),e}function w(e,t){return{...e.extra?.thunderbird??{},...t??{}}}import n from"joi";var p={generate(e,t,r,o){let s=r.extra.thunderbird;return{manifest_version:2,name:r.displayName??r.name,version:s.version,description:r.description,author:r.author?.name,homepage_url:r.author?.url,browser_specific_settings:{gecko:{id:s.themeId,strict_min_version:s.thunderbirdMinVersion}},theme:{colors:e.colors,images:t},theme_experiment:{stylesheet:o?`${r.name}.css`:void 0,colors:e.experimentColors}}},validate(e){let t=n.object({name:n.string().required(),version:n.string().pattern(/^(0|[1-9][0-9]{0,8})([.](0|[1-9][0-9]{0,8})){0,3}$/u).required(),displayName:n.string(),description:n.string(),author:n.object({name:n.string(),url:n.string()}),extra:n.object({thunderbird:n.object({name:n.string().required(),version:n.string().pattern(/^\d+([.]\d+){0,2}$/u),themeId:n.alternatives().try(n.string().email({tlds:{allow:!1}}),n.string().pattern(/^\{[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\}$/iu)),thunderbirdMinVersion:n.string().pattern(/^\d+(\.\d+)?$/u).required(),stylesPath:n.alternatives().try(n.string(),n.array().items(n.string())),author:n.object({name:n.string(),url:n.string()}).required(),srcDir:n.string().required(),outDir:n.string().required(),assetsDir:n.string()})})}).unknown();n.assert(e,t);let r=e.extra.thunderbird;if(r.assetsDir&&!l.pathExists(r.assetsDir))throw new Error(`Invalid assets directory '${r.assetsDir}'`)}};import T from"path";import{readdirSync as V}from"fs";import*as _ from"sass";import{lstatSync as D,readdirSync as P}from"fs";import b from"path";var g={getStylePaths(e){let t=e.stylesPath;if(!t)return;let r=(Array.isArray(t)?t:[t]).map(o=>b.join(e.srcDir,o));return r.forEach(o=>{if(o&&!l.pathExists(o))throw new Error(`Styles path "${o}" not found.`)}),r},processStylePaths(e){return(Array.isArray(e)?e:[e]).map(t=>D(t).isDirectory()?S(t):x(t)).join(`
`)}};function S(e){let t=["css","scss","sass"];return P(e).filter(r=>l.fileHasExtension(r,t)).sort().map(r=>x(b.join(e,r))).join(`
`)}function x(e){return _.compile(e,{style:"expanded"}).css}import a from"joi";var y={color_scheme:{themecol_light_01:"#336699"},theme_colors:{button_background_active:"",button_background_hover:"",frame:"",frame_inactive:"",icons:"",icons_attention:"",popup:"",popup_border:"",popup_highlight:"",popup_highlight_text:"",popup_text:"",sidebar:"",sidebar_border:"",sidebar_highlight:"",sidebar_highlight_border:"",sidebar_highlight_text:"",sidebar_text:"",tab_background_separator:"",tab_background_text:"",tab_line:"",tab_loading:"",tab_selected:"",tab_text:"",toolbar:"",toolbar_bottom_separator:"",toolbar_field:"",toolbar_field_border:"",toolbar_field_border_focus:"",toolbar_field_focus:"",toolbar_field_highlight:"",toolbar_field_highlight_text:"",toolbar_field_text:"",toolbar_field_text_focus:"",toolbar_text:"",toolbar_top_separator:"",toolbar_vertical_separator:""},theme_experiment_colors:{}};var f={parseColors(e){let t=E(e.color_scheme,e.theme_colors??{}),{colors:r,experimentColors:o}=O(e.color_scheme,e.theme_experiment_colors??{}),{colors:s,experimentColors:i}=F(e.color_scheme);return{colors:{...t,...r,...s},experimentColors:{...o,...i}}},validate(e){let t=a.object({color_scheme:a.object().pattern(a.string(),a.alternatives().try(a.number(),a.string())).required(),theme_colors:a.object().pattern(a.string(),a.string()),theme_experiment_colors:a.object().pattern(a.string(),a.string()),images:a.object().pattern(a.string(),a.string())});a.assert(e,t),A(e);let r=[...Object.values(e.theme_colors??{}),...Object.values(e.theme_experiment_colors??{})].filter((i,c,d)=>i===d[c]),o=r.filter(i=>!(i in e.color_scheme));if(o.length>0)throw new Error(`Missing color definitions:
${m(o)}`);let s=Object.keys(e.color_scheme).filter(i=>!r.includes(i));s.length>0&&console.warn(`* Colors not referenced in 'theme_colors' nor 'theme_experiment_colors':
${m(s)}`)}};function E(e,t){return Object.entries(t).reduce((r,[o,s])=>(r[o]=e[s],r),{})}function O(e,t){return Object.entries(t).reduce((r,[o,s])=>{let i=s+o.replaceAll("-","_"),c=e[s];return r.colors[i]=c,r.experimentColors[i]=o,r},{colors:{},experimentColors:{}})}function F(e){return Object.entries(e).reduce((t,[r,o])=>{t.colors[r]=o;let s=`--${r}`;return t.experimentColors[r]=s,t},{colors:{},experimentColors:{}})}function A(e){q(e),M(e)}function M(e){if(!e.theme_colors)return;let t=G(),r=Object.keys(e.theme_colors),o=r.filter(i=>!t.includes(i));if(o.length)throw new Error(`Invalid color keys:
${m(o)}
Valid colors are:
${m(t)}`);let s=t.filter(i=>!r.includes(i));s.length&&console.warn(`* Theme colors missing in 'theme_colors':
${m(s)}`)}function q(e){let t=Object.values(e.color_scheme).map(o=>o.replaceAll(" ","")),r=I(t);if(r.length)throw new Error(`Duplicated color keys:
${m(r)}`)}function I(e){return[...new Set(e.filter((t,r,o)=>o.indexOf(t)!==r))]}function G(){let e=y.theme_colors;return Object.keys(e)}function m(e){return JSON.stringify(e,null,1)}function ue(e,t){let r=h(t),o=r.extra.thunderbird;l.ensureDirectory(o.outDir);try{p.validate(r),f.validate(e)}catch(C){console.error(C),console.log();return}let s=g.getStylePaths(o),i=s?g.processStylePaths(s):void 0,c=f.parseColors(e),d=p.generate(c,e.images,r,!!i),v=J(d,r,i);N(d,v)}function J(e,t,r){let o=[{filename:"manifest.json",content:JSON.stringify(e,null,1)}];if(e.theme_experiment.stylesheet&&r&&o.push({filename:e.theme_experiment.stylesheet,content:r}),t.extra.thunderbird.assetsDir){let{assetsDir:c}=t.extra.thunderbird;V(c).forEach(d=>{o.push(T.join(c,d))})}let s=`${t.name.replaceAll(".","-")}.xpi`,i=T.join(t.extra.thunderbird.outDir,s);return l.zipCompress(i,o),i}function N(e,t){let r=[`Theme: ${e.name}`,`Id: ${e.browser_specific_settings.gecko.id}`,`Version: ${e.version}`,`File: ${t}`],o=r.reduce((s,i)=>i.length>s?i.length:s,0);console.log(`
 .${"-".repeat(o)}. `);for(let s of r){let i=" ".repeat(o-s.length);console.log(`| ${s}${i} |`)}console.log(` '${"-".repeat(o)}' `)}export{ue as build};
